# EP-11161: Proxy Protocol Support

* Issue: [#11161](https://github.com/kgateway-dev/kgateway/issues/11161)

## Background

The [Proxy Protocol](https://www.haproxy.org/download/2.1/doc/proxy-protocol.txt) provides a simple and safe way to preserve a client’s IP address when the client’s TCP connection passes through a proxy. Without such a mechanism, proxies lose this information because they act as a surrogate for the client, relaying messages to the server but replacing the client’s IP address with their own.
The Proxy Protocol works by adding a header that contains the client’s IP address, port and additional details at the beginning of a TCP connection.

Envoy supports the [Proxy Protocol](https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/proxy_protocol.html) that makes it aware that downstream clusters use the Proxy Protocol. Without enabling it, requests with the Proxy Protocol header are rejected and lead to service disruption.

## Motivation

Requests within a network might pass through load balancers and proxies before reaching the destination, leading to the original client’s connection information such as a client's IP address being lost. The destination and intermediate proxies might require the client information for logging, security, etc. and so implement the Proxy Protocol.

Envoy supports the [Proxy Protocol](https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/listener_filters/proxy_protocol.html) that assumes that the downstream connection is assumed to come from a proxy which places the original coordinates (IP, PORT) into a connection-string. This configuration should be exposed to the user to make Envoy aware that downstream clusters use this protocol and to allow such requests to flow through Envoy.

A use case is mentioned in https://github.com/kgateway-dev/kgateway/issues/11129 - The AWS LB has Proxy Protocol enabled, which adds the Proxy Protocol header. Envoy needs to be configured to be made aware of this to process the request. Since there is no way to enable this at present (make envoy aware that the Proxy Protocol is used), it returns a 400

### Goals
- Enable users to configure Proxy Protocol on the listener
  - This is translated to a listener filter and makes the listener aware that incoming requests use the Proxy Protocol.
  - It provides additional configuration such as setting custom rules to add metadata based on TLV fields.
- Enable users to allow Proxy Protocol on the backend
  - This is translated to the cluster Transport Socket and used to parse the Proxy Protocol header.
  - It provides additional configuration such as filtering and adding TLVs fields to pass on to the envoy cluster.

### Non-Goals
- Deploying a proxy to forward requests to envoy.
- Support configuring it globally (via Gateway Parameters).

## Implementation Details

### Configuration
A user can configure Envoy to be aware of downstreams that use the Proxy Protocol via the `HTTPListenerPolicy`:

```yaml
apiVersion: gateway.kgateway.dev/v1alpha1
kind: HTTPListenerPolicy
  name: proxy-protocol-config
spec:
  proxyProtocol:
    allowRequestsWithoutProxyProtocol: true
```

The `http_listener_policy_types.go` will be modified to add the following fields :
```go
// HTTPListenerPolicySpec defines the desired state of a HTTP listener policy.
type HTTPListenerPolicySpec struct {
  // ProxyProtocol configures the [Proxy Protocol listener filter](https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/filters/listener/proxy_protocol/v3/proxy_protocol.proto).
  // +optional
  ProxyProtocol *ProxyProtocol `json:"proxyProtocol,omitempty"`
}

// ProxyProtocol represents configuration for Envoy's Proxy Protocol filter.
type ProxyProtocol struct {
  // The list of rules to apply to requests.
  // +optional
  Rules []ProxyProtocolRule `json:"rules,omitempty"`

  // Allow requests through that don't use Proxy Protocol. Defaults to false.
  // +optional
  AllowRequestsWithoutProxyProtocol *bool `json:"allowRequestsWithoutProxyProtocol,omitempty"`
}

// A Rule defines what metadata to apply when a header is present or missing.
type ProxyProtocolRule struct {
  // The type that triggers the rule
  // TLV type is defined as uint8_t in Proxy Protocol. See [the spec](https://www.haproxy.org/download/2.1/doc/proxy-protocol.txt) for details.
  // +required
  TlvType uint32 `json:"tlvType,omitempty"`
  // If the TLV type is present, apply this metadata KeyValuePair.
  OnTlvPresent *ProxyProtocolKeyValuePair `json:"onTlvPresent,omitempty"`
}

type ProxyProtocolKeyValuePair struct {
  // The namespace — if this is empty, the filter's namespace will be used.
  MetadataNamespace *string `json:"metadataNamespace,omitempty"`
  // The key to use within the namespace.
  Key *string `json:"key,omitempty"`
}
```

Additionally the backend (envoy upstream cluster) can be configured to understand and parse the Proxy Protocol header

```yaml
kind: BackendConfigPolicy
apiVersion: gateway.kgateway.dev/v1alpha1
metadata:
  name: example-policy
spec:
  targetRefs:
    - name: example-svc
      group: ""
      kind: Service
  proxyProtocol:
    version: v1
    passThroughTlvs:
      type: ALL
```

The `backend_config_policy_types.go` will be modified to add the following fields :
```go
// BackendConfigPolicySpec defines the desired state of BackendConfigPolicy.
type BackendConfigPolicySpec struct {
  // Configuration for Proxy Protocol socket
  // +optional
  ProxyProtocol *ProxyProtocol `json:"proxyProtocol,omitempty"`
}

type ProxyProtocol struct {
  // The Proxy Protocol version to use. See https://www.haproxy.org/download/2.1/doc/proxy-protocol.txt for details
  Version int `json:"version,omitempty"`

  // This config controls which TLVs can be passed to upstream if it is Proxy Protocol V2 header.
  PassThroughTlvs *PassThroughTlvs `json:"passThroughTlvs,omitempty"`
}

// A Rule defines what metadata to apply when a header is present or missing.
type PassThroughTlvs struct {
  // The type that triggers the rule
  // TLV type is defined as uint8_t in Proxy Protocol. See [the spec](https://www.haproxy.org/download/2.1/doc/proxy-protocol.txt) for details.
  // +required
  Type Type `json:"type,omitempty"`
}
```

### Plugin

The existing `httplistenerpolicy` && `backendconfigpolicy` plugins can be modified to support the Proxy Protocol

### Controllers

No new controllers will be required for this feature. The existing plugins will be updated to support this.

### Deployer

The CRDs will be updated with the new fields along with the required validation

### Test Plan

The testing plan will include unit and kubernetes end to end tests to verify the feature

## Alternatives
- The backend service itself can be annotated to indicate whether it supports the Proxy Protocol.

## Open Questions
- Which fields in [ProxyProtocolConfig](https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/proxy_protocol.proto.html#config-core-v3-proxyprotocolconfig) need to be supported ?
- Should the Proxy Protocol be supported by default with `allowRequestsWithoutProxyProtocol` set to true to avoid users needing to manually configure it.
